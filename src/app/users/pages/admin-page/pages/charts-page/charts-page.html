<div class="statistics-container">
  <div class="page-header">
    <h1>
      <mat-icon>bar_chart</mat-icon>
      Estadísticas del Sistema
    </h1>
  </div>

  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando estadísticas...</p>
  </div>
  } @else if (error()) {
  <mat-card class="error-card">
    <mat-card-content>
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error() }}</p>
    </mat-card-content>
  </mat-card>
  } @else { @if (generalStats(); as stats) {
  <div class="summary-cards">
    <mat-card class="stat-card viajes">
      <mat-card-content>
        <div class="card-icon">
          <mat-icon>directions_bus</mat-icon>
        </div>
        <div class="card-info">
          <h2>{{ stats.total_viajes }}</h2>
          <p>Total Viajes</p>
          <span class="sub-info"
            >{{ stats.viajes_completados }} completados</span
          >
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card usuarios">
      <mat-card-content>
        <div class="card-icon">
          <mat-icon>people</mat-icon>
        </div>
        <div class="card-info">
          <h2>{{ stats.usuarios_activos }}</h2>
          <p>Usuarios Activos</p>
          <span class="sub-info"
            >{{ stats.total_personal }} personal, {{ stats.total_visitantes }}
            visitantes</span
          >
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card vehiculos">
      <mat-card-content>
        <div class="card-icon">
          <mat-icon>local_shipping</mat-icon>
        </div>
        <div class="card-info">
          <h2>{{ stats.total_vehiculos }}</h2>
          <p>Vehículos</p>
          <span class="sub-info">{{ stats.vehiculos_en_viaje }} en viaje</span>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card calificacion">
      <mat-card-content>
        <div class="card-icon">
          <mat-icon>star</mat-icon>
        </div>
        <div class="card-info">
          <h2>{{ formatRating(stats.promedio_calificaciones_general) }}</h2>
          <p>Calificación Promedio</p>
          <span class="sub-info"
            >{{ stats.total_calificaciones }} calificaciones</span
          >
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  }

  <mat-divider></mat-divider>

  <mat-tab-group class="stats-tabs">
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>place</mat-icon>
        Destinos
      </ng-template>

      <div class="tab-content">
        <h2>Destinos Más Utilizados</h2>

        @if (topDestinations().length > 0) {
        <mat-card>
          <mat-card-content>
            <table
              mat-table
              [dataSource]="topDestinations()"
              class="stats-table"
            >
              <ng-container matColumnDef="nomdestino">
                <th mat-header-cell *matHeaderCellDef>Destino</th>
                <td mat-cell *matCellDef="let dest">
                  <strong>{{ dest.nomdestino }}</strong>
                </td>
              </ng-container>

              <ng-container matColumnDef="total_viajes">
                <th mat-header-cell *matHeaderCellDef>Total Viajes</th>
                <td mat-cell *matCellDef="let dest">
                  <mat-chip>{{ dest.total_viajes }}</mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="viajes_completados">
                <th mat-header-cell *matHeaderCellDef>Completados</th>
                <td mat-cell *matCellDef="let dest">
                  {{ dest.viajes_completados }} / {{ dest.total_viajes }}
                </td>
              </ng-container>

              <ng-container matColumnDef="promedio_calificacion">
                <th mat-header-cell *matHeaderCellDef>Calificación</th>
                <td mat-cell *matCellDef="let dest">
                  @if (dest.promedio_calificacion) {
                  <mat-chip
                    [color]="getRatingColor(dest.promedio_calificacion)"
                  >
                    {{ formatRating(dest.promedio_calificacion) }}
                  </mat-chip>
                  } @else {
                  <span class="no-data">Sin calificaciones</span>
                  }
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="destinationsColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: destinationsColumns"
              ></tr>
            </table>
          </mat-card-content>
        </mat-card>
        } @else {
        <app-emptystate />
        }
      </div>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>event_busy</mat-icon>
        Inasistencias
      </ng-template>

      <div class="tab-content">
        <h2>Usuarios con Más Inasistencias</h2>

        @if (topAbsences().length > 0) {
        <mat-card>
          <mat-card-content>
            <table mat-table [dataSource]="topAbsences()" class="stats-table">
              <ng-container matColumnDef="nombre_completo">
                <th mat-header-cell *matHeaderCellDef>Usuario</th>
                <td mat-cell *matCellDef="let user">
                  <div class="user-info">
                    <strong>{{ user.nombre_completo }}</strong>
                    <span class="ci">CI: {{ user.ci }}</span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="rol">
                <th mat-header-cell *matHeaderCellDef>Rol</th>
                <td mat-cell *matCellDef="let user">
                  <mat-chip>{{ user.rol }}</mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="total_inasistencias">
                <th mat-header-cell *matHeaderCellDef>Inasistencias</th>
                <td mat-cell *matCellDef="let user">
                  <mat-chip color="warn"
                    >{{ user.total_inasistencias }}</mat-chip
                  >
                </td>
              </ng-container>

              <ng-container matColumnDef="total_viajes">
                <th mat-header-cell *matHeaderCellDef>Total Viajes</th>
                <td mat-cell *matCellDef="let user">{{ user.total_viajes }}</td>
              </ng-container>

              <ng-container matColumnDef="porcentaje_inasistencias">
                <th mat-header-cell *matHeaderCellDef>Porcentaje</th>
                <td mat-cell *matCellDef="let user">
                  <mat-chip
                    [color]="getAbsenceColor(user.porcentaje_inasistencias)"
                  >
                    {{ formatPercentage(user.porcentaje_inasistencias) }}
                  </mat-chip>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="absencesColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: absencesColumns"></tr>
            </table>
          </mat-card-content>
        </mat-card>
        } @else {
        <app-emptystate />
        }
      </div>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>badge</mat-icon>
        Conductores
      </ng-template>

      <div class="tab-content">
        <h2>Conductores con Mejor Desempeño</h2>

        @if (topDrivers().length > 0) {
        <mat-card>
          <mat-card-content>
            <table mat-table [dataSource]="topDrivers()" class="stats-table">
              <ng-container matColumnDef="nombre_completo">
                <th mat-header-cell *matHeaderCellDef>Conductor</th>
                <td mat-cell *matCellDef="let driver">
                  <div class="user-info">
                    <strong>{{ driver.nombre_completo }}</strong>
                    <span class="ci">CI: {{ driver.ci }}</span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="total_viajes_realizados">
                <th mat-header-cell *matHeaderCellDef>Viajes</th>
                <td mat-cell *matCellDef="let driver">
                  <mat-chip>{{ driver.total_viajes_realizados }}</mat-chip>
                </td>
              </ng-container>

              <ng-container matColumnDef="promedio_calificacion">
                <th mat-header-cell *matHeaderCellDef>Calificación</th>
                <td mat-cell *matCellDef="let driver">
                  @if (driver.promedio_calificacion) {
                  <mat-chip
                    [color]="getRatingColor(driver.promedio_calificacion)"
                  >
                    {{ formatRating(driver.promedio_calificacion) }}
                  </mat-chip>
                  } @else {
                  <span class="no-data">Sin calificaciones</span>
                  }
                </td>
              </ng-container>

              <ng-container matColumnDef="tasa_asistencia_pasajeros">
                <th mat-header-cell *matHeaderCellDef>Tasa Asistencia</th>
                <td mat-cell *matCellDef="let driver">
                  <mat-chip color="primary">
                    {{ formatPercentage(driver.tasa_asistencia_pasajeros) }}
                  </mat-chip>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="driversColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: driversColumns"></tr>
            </table>
          </mat-card-content>
        </mat-card>
        } @else {
        <app-emptystate />
        }
      </div>
    </mat-tab>


  </mat-tab-group>
  }
</div>
