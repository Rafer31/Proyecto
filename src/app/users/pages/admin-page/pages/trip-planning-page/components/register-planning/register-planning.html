<div class="dialog-container">
  @if (etapaActual() === 'salida') {
    <form [formGroup]="formTrip">
      <mat-horizontal-stepper linear>
        <mat-step [stepControl]="step1Form">
          <form [formGroup]="step1Form">
            <ng-template matStepLabel>Asociar Conductor</ng-template>

            <div class="form-row">
              @if (loadingConductores()) {
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Cargando conductores...</mat-label>
                  <mat-select [disabled]="true">
                    <mat-option>Cargando...</mat-option>
                  </mat-select>
                </mat-form-field>
              } @else if (conductores().length === 0) {
                <div class="no-data-message">
                  <mat-icon>info</mat-icon>
                  <p>No hay conductores disponibles</p>
                </div>
              } @else {
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Conductor</mat-label>
                  <mat-select formControlName="idconductor" required>
                    @for (c of conductores(); track trackByConductor($index, c)) {
                      <mat-option [value]="c.idconductor">
                        {{ c.nombre }} <span class="muted">({{ c.ci }})</span>
                      </mat-option>
                    }
                  </mat-select>
                  @if (step1Form.get('idconductor')?.hasError('required')) {
                    <mat-error>Seleccione un conductor</mat-error>
                  }
                </mat-form-field>
              }

              @if (loadingVehiculos()) {
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Cargando vehículos...</mat-label>
                  <mat-select [disabled]="true">
                    <mat-option>Cargando...</mat-option>
                  </mat-select>
                </mat-form-field>
              } @else if (vehiculos().length === 0) {
                <div class="no-data-message">
                  <mat-icon>info</mat-icon>
                  <p>No hay vehículos disponibles</p>
                </div>
              } @else {
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Vehículo</mat-label>
                  <mat-select
                    formControlName="nroplaca"
                    required
                    (selectionChange)="onVehiculoSelected($event.value)"
                  >
                    @for (v of vehiculos(); track trackByVehiculo($index, v)) {
                      <mat-option [value]="v.nroplaca">
                        {{ v.tipovehiculo }} ({{ v.nroasientos }} asientos)
                      </mat-option>
                    }
                  </mat-select>
                  @if (step1Form.get('nroplaca')?.hasError('required')) {
                    <mat-error>Seleccione un vehículo</mat-error>
                  }
                </mat-form-field>
              }
            </div>

            <mat-form-field appearance="outline" class="form-field-full">
              <mat-label>Empresa</mat-label>
              <mat-select formControlName="idempresa" required>
                @for (e of empresas(); track trackByEmpresa($index, e)) {
                  <mat-option [value]="e.idempresa">{{ e.nomempresa }}</mat-option>
                }
              </mat-select>
              @if (step1Form.get('idempresa')?.hasError('required')) {
                <mat-error>Seleccione una empresa</mat-error>
              }
            </mat-form-field>

            <div class="actions">
              <button
                mat-button
                matStepperNext
                [disabled]="loadingData() || step1Form.invalid || conductores().length === 0 || vehiculos().length === 0"
              >
                Siguiente
              </button>
            </div>
          </form>
        </mat-step>

        <mat-step [stepControl]="step2Form">
          <form [formGroup]="step2Form">
            <ng-template matStepLabel>Planificación de Salida</ng-template>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Fecha Partida</mat-label>
                <input
                  matInput
                  [matDatepicker]="picker1"
                  formControlName="fechapartida"
                  required
                />
                <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                <mat-datepicker #picker1></mat-datepicker>
                @if (step2Form.get('fechapartida')?.hasError('required')) {
                  <mat-error>Requerido</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Fecha Llegada</mat-label>
                <input
                  matInput
                  [matDatepicker]="picker2"
                  formControlName="fechallegada"
                  required
                />
                <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                <mat-datepicker #picker2></mat-datepicker>
                @if (step2Form.get('fechallegada')?.hasError('fechaLlegadaMenor')) {
                  <mat-error>Fecha inválida</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="turno-section">
              <label class="section-label">Turno</label>
              <div class="checkbox-group">
                @for (turno of turnos; track trackByTurno($index, turno)) {
                  <mat-checkbox
                    [checked]="isTurnoSeleccionado(turno.value)"
                    (change)="toggleTurno(turno.value, $event.checked)"
                  >
                    {{ turno.label }}
                  </mat-checkbox>
                }
              </div>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Hora de Partida</mat-label>
                <mat-select formControlName="horapartida" required>
                  @for (hora of horasFiltradas(); track trackByHora($index, hora)) {
                    <mat-option [value]="hora">{{ hora }}</mat-option>
                  }
                </mat-select>
                @if (step2Form.get('horapartida')?.hasError('required')) {
                  <mat-error>Requerido</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Destino</mat-label>
                <mat-select formControlName="iddestino" required>
                  @for (d of destinos(); track trackByDestino($index, d)) {
                    <mat-option [value]="d.iddestino">{{ d.nomdestino }}</mat-option>
                  }
                </mat-select>
                @if (step2Form.get('iddestino')?.hasError('required')) {
                  <mat-error>Requerido</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="actions">
              <button mat-button matStepperPrevious>Volver</button>
              <button
                mat-flat-button
                color="primary"
                (click)="onSubmitSalida()"
                [disabled]="step2Form.invalid"
              >
                Registrar Salida
              </button>
            </div>
          </form>
        </mat-step>
      </mat-horizontal-stepper>
    </form>
  }

  @if (etapaActual() === 'pregunta-retorno') {
    <div class="pregunta-retorno">
      <div class="icon-success">
        <mat-icon>check_circle</mat-icon>
      </div>
      <h2>¡Viaje de salida registrado!</h2>
      <p>¿Desea programar un viaje de retorno a Bolívar?</p>
      <p class="info-text">
        Se usará el mismo conductor, vehículo y empresa para el retorno.
      </p>

      <div class="actions-center">
        <button mat-button (click)="onDecidirRetorno(false)">
          No, finalizar
        </button>
        <button mat-flat-button color="primary" (click)="onDecidirRetorno(true)">
          <mat-icon>keyboard_return</mat-icon>
          Sí, programar retorno
        </button>
      </div>
    </div>
  }
  @if (etapaActual() === 'retorno') {
    <div class="retorno-header">
      <mat-icon>keyboard_return</mat-icon>
      <h2>Planificación del Retorno</h2>
    </div>

    <form [formGroup]="step2Form" class="retorno-form">
      <div class="destino-fijo">
        <mat-icon>place</mat-icon>
        <span>Destino: <strong>{{ destinosRetorno()[0]?.nomdestino || 'Bolívar' }}</strong></span>
      </div>

      <input type="hidden" formControlName="iddestino" />

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Fecha Partida</mat-label>
          <input
            matInput
            [matDatepicker]="pickerR1"
            formControlName="fechapartida"
            required
          />
          <mat-datepicker-toggle matSuffix [for]="pickerR1"></mat-datepicker-toggle>
          <mat-datepicker #pickerR1></mat-datepicker>
          @if (step2Form.get('fechapartida')?.hasError('required')) {
            <mat-error>Requerido</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Fecha Llegada</mat-label>
          <input
            matInput
            [matDatepicker]="pickerR2"
            formControlName="fechallegada"
            required
          />
          <mat-datepicker-toggle matSuffix [for]="pickerR2"></mat-datepicker-toggle>
          <mat-datepicker #pickerR2></mat-datepicker>
          @if (step2Form.get('fechallegada')?.hasError('fechaLlegadaMenor')) {
            <mat-error>Fecha inválida</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="turno-section">
        <label class="section-label">Turno</label>
        <div class="checkbox-group">
          @for (turno of turnos; track trackByTurno($index, turno)) {
            <mat-checkbox
              [checked]="isTurnoSeleccionado(turno.value)"
              (change)="toggleTurno(turno.value, $event.checked)"
            >
              {{ turno.label }}
            </mat-checkbox>
          }
        </div>
      </div>

      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Hora de Partida</mat-label>
        <mat-select formControlName="horapartida" required>
          @for (hora of horasFiltradas(); track trackByHora($index, hora)) {
            <mat-option [value]="hora">{{ hora }}</mat-option>
          }
        </mat-select>
        @if (step2Form.get('horapartida')?.hasError('required')) {
          <mat-error>Requerido</mat-error>
        }
      </mat-form-field>


      <div class="actions">
        <button mat-button (click)="volverAPregunta()">Cancelar</button>
        <button
          mat-flat-button
          color="primary"
          (click)="onSubmitRetorno()"
          [disabled]="step2Form.invalid || step2Form.get('horapartida')?.disabled"
        >
          Registrar Retorno
        </button>
      </div>
    </form>
  }
</div>
