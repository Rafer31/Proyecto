<div class="add-user-dialog">
  <h2 mat-dialog-title>
    <mat-icon>person_add</mat-icon>
    Agregar Nuevo Usuario
  </h2>

  <mat-dialog-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Datos básicos del usuario -->
      <div class="form-section">
        <h3 class="mb-3">Información Personal</h3>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width mt-2 mb-3">
            <mat-label>Cédula de Identidad</mat-label>
            <input matInput formControlName="ci" />
            <mat-hint>Entre 7 y 10 dígitos</mat-hint>
            <mat-error>{{ getErrorMessage('ci') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width mt-2 mb-3">
            <mat-label>Número de Celular</mat-label>
            <input matInput formControlName="numcelular" />
            <mat-hint>8 dígitos, debe empezar con 6 o 7</mat-hint>
            <mat-error>{{ getErrorMessage('numcelular') }}</mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full-width mt-3">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" />
          <mat-error>{{ getErrorMessage('nombre') }}</mat-error>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width mt-2">
            <mat-label>Apellido Paterno</mat-label>
            <input matInput formControlName="paterno" />
            <mat-error>{{ getErrorMessage('paterno') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width mt-2">
            <mat-label>Apellido Materno</mat-label>
            <input matInput formControlName="materno" />
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width mt-2">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" />
            <mat-error>{{ getErrorMessage('email') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width mt-2">
            <mat-label>Rol</mat-label>
            <mat-select formControlName="rol">
              @for (role of roles; track role.idrol) {
              <mat-option [value]="role.nomrol">{{ role.nomrol }}</mat-option>
              }
            </mat-select>
            <mat-error>{{ getErrorMessage('rol') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Campos específicos por rol -->
      @if (selectedRole === 'Personal' || selectedRole === 'Administrador') {
      <div class="form-section">
        <h3 class="mt-3">Información de {{ selectedRole }}</h3>

        <mat-form-field appearance="outline" class="full-width mt-4">
          <mat-label>Destino</mat-label>
          <mat-select formControlName="iddestino" required>
            @for (d of destinos(); track d.iddestino) {
            <mat-option [value]="d.iddestino"> {{ d.nomdestino }} </mat-option>
            }
          </mat-select>
          @if (form.get('iddestino')?.hasError('required')) {
          <mat-error>Debe seleccionar un destino</mat-error>
          }
        </mat-form-field>

        <div class="form-row">
              <mat-form-field appearance="outline" class="half-width mt-3">
            <mat-label>Operación</mat-label>
            <mat-select formControlName="operacion" required>
              <mat-option value="Bolívar">Bolívar</mat-option>
              <mat-option value="Porco">Porco</mat-option>
              <mat-option value="La Paz">La Paz</mat-option>
              <mat-option value="Tres Amigos">Tres Amigos</mat-option>
              <mat-option value="Caballo Blanco">Caballo Blanco</mat-option>
              <mat-option value="Colquechaquita">Colquechaquita</mat-option>
            </mat-select>
            @if (getErrorMessage('operacion')) {
            <mat-error>La operación es requerida</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width mt-3">
            <mat-label>Número de Ficha</mat-label>
            <input matInput formControlName="nroficha" />
            <mat-error>{{ getErrorMessage('nroficha') }}</mat-error>
          </mat-form-field>
        </div>
      </div>
      } @if (selectedRole === 'Visitante') {
      <div class="form-section mt-3">
        <h3>Información del Visitante</h3>

        <mat-form-field appearance="outline" class="full-width mt-2">
          <mat-label>Información Adicional</mat-label>
          <textarea
            matInput
            formControlName="informacion"
            rows="3"
            placeholder="Empresa, motivo de visita, etc."
          ></textarea>
          <mat-error>{{ getErrorMessage('informacion') }}</mat-error>
        </mat-form-field>
      </div>
      } @if (selectedRole === 'Conductor') {
      <div class="form-section mt-2">
        <h3>Información del Conductor</h3>
        <p class="info-text flex flex-row items-center mt-3">
          <mat-icon class="me-1">info</mat-icon>
          El conductor no cuenta con información extra
        </p>
      </div>
      }
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="onCancel()" [disabled]="loading">
      Cancelar
    </button>

    <button
      mat-flat-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="form.invalid || loading"
    >
      @if (loading) {
      <mat-spinner diameter="20"></mat-spinner>
      } @else {
      <mat-icon>save</mat-icon>
      } {{ loading ? 'Guardando...' : 'Guardar Usuario' }}
    </button>
  </mat-dialog-actions>
</div>
